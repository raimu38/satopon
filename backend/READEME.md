API 使用

#AUTH
##ユーザー登録(googleのみ、 supabaseで登録(今後firebaseに変更するおそれあり。よってデータの移行などは面倒なのでそれは自分で管理しこれらのbaasには認証管理だけしてもらう。これだけなら無料なので)
 - 登録時にmongodb にユーザー情報を登録(ユーザー名、ユーザーid, email, 登録日時)
##ログイン どのページでも必ずログインしているかを確認する(websocket?)ログインしたらredisに情報登録
 - ログイン中は他のユーザーから見て誰がログインしているのかわかるようにする。
 ## ユーザー
    - 登録
    - 更新
    - 削除
    - 取得
 
## ログイン後
 - 自分のアカウント情報を取得 supabaseより アイコン画像　、メールアドレス取得
 - 名前の変更、更新をできるようにする (mongodbに保存)
## ログアウト
 - redisにてログアウトを確認。websocketで通知しユーザー一覧でログアウトに切り替わる。ブラウザを閉じたりしたら勝手にログアウトする。
 - 

- 　他のユーザーのここの情報を取得表示
## ゲームルーム
    - ルームの作成(ルームid,ルーム名、ルームの説明、色を指定、作者、作成日時、)
    - ルーム更新(id,ルーム名、ルームの説明、色を指定、作者のみ更新可能、更新日時)
    - ルームの削除(id,アーカイブしておく一様消さずに残して見た目だけ削除的な感じにしておく)
    - ルーム一覧取得(id,ルーム名、説明、色、作者、作成日時)
    
## ルーム
    - ルームに参加(ルームid, ログイン中のユーザーに通知、誰か一人が承認すれば許可すれば入れる)
    - ルームを退会(そのルーム内での自分のポイントが+-0のときのみ退会可能)

## ルーム内にてポイント管理
    - ポイント登録(ルームの誰かがルーム内のメンバーを指定ポイント登録ボタンを押すそのルームない and ログイン中のユーザーに通知がいく、ユーザーはそこでそのゲームでのポイントを記入しOKを押す)集計を開始するバックエンドで処理をし必ず合計が0担っているかを確認した上で全員に集計結果を送信する。もし途中で誰かがログアウトしたりしたらその時点で集計を強制停止)再度全員に集計結果が送られ全員が確認して承認を押すとそのゲームでの結果が記録される。websocketやredisを使用し　確定したらmongodbに保存　一度決めたらもう取り消せない
    - 精算 例えばA,B,Cさんがいて A + 50p , B +20p, C - 70pとする。この時Cさんは A, Bさんに 50, 20ポイント分奢らなければいけない。そしておごったことを確認したらこれが帳消しになるような仕組みを作る。 A,Cがログインしてルームに入る。Cは精算というボタンを押すと A ,B という候補が現れる。逆にAさんはそれを押しても何も現れない。- の人のみ。 そしてCさんは一人を選ぶ ここではAさんを選ぶ。そしてAさんに対してもし40p分おごったら40精算できることになる CさんはAさんを指定して 入力欄に40と入力する。するとAさんに通知がいきAさんが承諾すると精算が行われAさんのポイントは+10, Cさんは-30　になる。




     
# satopon 詳細仕様書

## 概要

- **satopon** は少人数グループでのポイント管理・精算をリアルタイムかつシンプルに行うアプリケーション。
- 認証は Google（Supabase, Firebase など BaaS）に委譲。ユーザープロフィールやゲームデータは MongoDB、リアルタイムなオンライン状態や通知は Redis で管理。
- ルーム参加やポイント記録、精算などで WebSocket/FastAPI を活用し、全てのアクションは明確に記録・履歴管理される。

---

## 1. ユーザー管理

### 1.1 認証

- Google（BaaS：Supabase）認証のみ。今後 Firebase 等に移行しても同じインターフェースを維持。
- 認証完了後、以下の情報を MongoDB に初回登録する。
    - `user_id`（BaaSサブID等、グローバル一意）
    - `display_name`（表示名、変更可）
    - `email`（BaaSから取得、表示専用）
    - `icon_url`（GoogleアイコンURL、表示専用）
    - `registered_at`（登録日時）

### 1.2 プロフィール

- `display_name` のみアプリから編集可。メールやアイコンはBaaS同期のみ。
- プロフィール編集・取得・論理削除が可能。

### 1.3 オンライン状態管理

- ログイン時に Redis に `user_id` を登録＝「オンライン」状態
- ログアウト/切断時には Redis から削除
- WebSocket の PING/PONG で切断検知し、即時に反映
- オンライン状態は全クライアントにリアルタイム反映（WebSocket経由）

---

## 2. ユーザー一覧・状態表示

- ユーザーリストは MongoDB の全ユーザー＋ Redis のオンライン状態を合成
- UI上でオンラインユーザーは明るく、オフラインはグレー表示
- 各ユーザーのプロフィール画像・名前・メール・状態を表示

---

## 3. ルーム管理

### 3.1 ルーム属性

- `room_id`（UUID等）、`name`（ルーム名）、`description`（説明）、`color_id`（単色でOK）、`created_by`、`created_at`、`is_archived`（論理削除）
- `members[]`（`user_id`・各メンバー情報）

### 3.2 ルーム作成・編集・削除

- 作成：誰でも可
- 編集：作成者のみ可
- 削除：全メンバーのルーム内ポイント合計が0の場合のみ。物理削除ではなく `is_archived` フラグで論理削除

---

## 4. ルーム参加・退会フロー

### 4.1 参加申請・承認

- 参加申請すると、「ルーム内ログイン中の誰か1人」にWebSocket通知
- 誰か1人が**承認**すれば参加確定。**拒否 or 10秒タイムアウト**で申請失敗
- 申請失敗時はユーザーに理由を明示
- 再申請は可能

### 4.2 退会

- 自分のルーム内ポイントが0ならのみ退会可
- MongoDBでメンバーリストから自分を remove

---

## 5. ポイント登録・履歴管理

### 5.1 ポイント登録

- ルーム内で全メンバー同時にポイントを入力
- **合計0になるまで進行不可**（サーバ側で厳格チェック）
- 途中で誰かがログアウト/拒否→即時中断、履歴は**保存しない**
- 全員が承認した場合のみ MongoDB に履歴として保存（編集不可）

### 5.2 精算

- **1:1精算のみ許可**（一度に複数にはできない）
- マイナスの人がプラスの人を指定して精算申請。金額を入力
- 相手が承諾→双方のポイント更新、精算履歴をMongoDBに記録
- 精算履歴は編集不可、論理削除のみ可

---

## 6. リアルタイム通知・同期

- WebSocket（FastAPI+Redis Pub/Sub）で各種アクションをリアルタイム通知
    - 参加申請/承認、ポイント入力開始・結果通知、精算通知、ログイン状態更新など
- Redisは「オンライン管理」「一時的な承認状態管理」「Pub/Sub中継」に利用

---

## 7. DB・ストレージ設計指針

- 永続化（ユーザー・ルーム・履歴等）：MongoDB
- 状態・一時情報・通知：Redis
- 色・UI関連属性：MongoDB内にIDで管理（拡張時も柔軟に対応可）

---

## 8. 機能テーブル

| カテゴリ      | 機能                           | DB       | 備考                   |
| ------------- | ------------------------------ | -------- | ---------------------- |
| Auth/User     | 認証・登録・編集・取得・削除   | MongoDB  | BaaS依存、論理削除     |
| Online        | オンライン/オフライン管理      | Redis    | WebSocketリアルタイム   |
| Room          | 作成・編集・削除・一覧         | MongoDB  | is_archivedで管理      |
| RoomEntry     | 参加申請・承認・退会           | Redis+MongoDB | 10秒タイムアウト   |
| Point         | ポイント登録・履歴取得         | MongoDB  | 合計0厳守              |
| Settlement    | 精算処理・承認・記録           | MongoDB  | 1:1のみ、編集不可      |

---

## 9. 運用・制約・今後の拡張

- 認証やユーザーデータ移行時にもMongoDBを主体に管理
- API・画面遷移時には必ず認証状態チェック（未ログインならリダイレクト）
- ルームの色拡張や属性拡張もDB設計上容易
- 冗長構成や拡張は将来のクラウド/VPS運用時に対応

---

## 10. 仕様確定事項（2025/06 時点）

- ルーム参加承認：誰か一人が承認すればOK。**再申請可**
- ポイント登録：**全員承認必須**。途中中断時は最初からやり直し
- 履歴の削除：**論理削除のみ**。編集不可
- ログイン状態：WebSocket＋Redisでリアルタイム管理
- ルーム色：**単色のみ**（拡張容易な設計）

---

## 11. 今後の検討・質問（明確化済み）

- 参加承認/拒否は一人で決定、再申請も許容
- ポイント登録は必ず全員の承認が必要
- 履歴削除は論理削除のみ許可
- ログイン/オンライン管理はRedis+WebSocketで十分
- ルーム色等は一旦単色のみ、必要なら将来拡張

---

**このドキュメントをベースに、API設計・DBスキーマ設計・画面仕様設計を進めていく。**
